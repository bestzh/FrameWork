---@diagnostic disable: undefined-global
---@diagnostic disable: unused-local
-- 对话管理器 - Lua实现
-- 统一管理NPC对话UI的显示和隐藏
-- 支持单段对话和多段对话（对话树）

local DialogueManager = {}

-- 对话UI设置
local dialogueUIPath = "UI/DialogueUI"
local currentDialogueUI = nil
local isDialogueActive = false

-- 当前对话状态（用于多段对话）
local currentDialogueState = {
    npcID = nil,           -- 当前对话的NPC ID
    currentNodeId = nil,   -- 当前对话节点ID
    tree = nil,            -- 当前对话树
    onClosed = nil         -- 对话关闭回调
}

-- 显示对话
-- npcName: NPC名称
-- dialogue: 对话内容
-- avatarPath: NPC头像路径（可选）
-- options: 对话选项列表（可选）格式: {{text="选项1", action="open_shop", nextDialogueId=1}, {text="选项2", action="close"}}
-- onOptionSelected: 选项选择回调（可选）function(option, index)
-- onClosed: 对话关闭回调（可选）
function DialogueManager.ShowDialogue(npcName, dialogue, avatarPath, options, onOptionSelected, onClosed)
    print("[DialogueManager] ShowDialogue被调用")
    print("[DialogueManager] 回调状态 - onOptionSelected: " .. tostring(onOptionSelected ~= nil) .. ", onClosed: " .. tostring(onClosed ~= nil))
    
    -- 如果已有对话在显示，先关闭
    if isDialogueActive and currentDialogueUI then
        DialogueManager.CloseDialogue()
    end
    
    -- 获取DialogueUI模块（先加载模块）
    local dialogueUIModule = require("ui.DialogueUI")
    if not dialogueUIModule then
        print("[DialogueManager] 错误: 无法加载DialogueUI模块")
        -- 后备方案：使用Debug输出
        print("=== " .. (npcName or "") .. " ===")
        print(dialogue or "")
        if onClosed then
            onClosed()
        end
        return
    end
    
    -- 加载对话UI（如果还未加载）
    if not currentDialogueUI then
        -- 使用Lua驱动的UI加载，自动加载对应的Lua脚本
        currentDialogueUI = UIHelper.LoadLuaUI("DialogueUI", dialogueUIPath, nil, false)
        
        if not currentDialogueUI then
            print("[DialogueManager] 错误: 无法加载对话UI，路径: " .. dialogueUIPath)
            print("请确保：")
            print("1. UI预制体存在于 Resources/" .. dialogueUIPath .. ".prefab")
            print("2. 预制体上有LuaUIBase组件")
            print("3. 预制体路径正确")
            -- 后备方案：使用Debug输出
            print("=== " .. (npcName or "") .. " ===")
            print(dialogue or "")
            if onClosed then
                onClosed()
            end
            return
        end
    end
    
    print("[DialogueManager] 准备调用DialogueUI.ShowDialogue，回调状态 - onOptionSelected: " .. tostring(onOptionSelected ~= nil))
    
    -- 显示对话（通过模块函数）
    dialogueUIModule.ShowDialogue(
        npcName, 
        dialogue, 
        avatarPath, 
        options or {},  -- 传递选项列表
        onOptionSelected,  -- 传递选项选择回调
        function()
            isDialogueActive = false
            if onClosed then
                onClosed()
            end
        end
    )
    
    print("[DialogueManager] DialogueUI.ShowDialogue调用完成")
    
    -- 显示UI（直接使用已加载的UI对象）
    if currentDialogueUI then
        local luaUI = currentDialogueUI:GetComponent("LuaUIBase")
        if luaUI then
            luaUI:Show()
        else
            -- 如果找不到组件，使用ShowLuaUI作为后备方案
            UIHelper.ShowLuaUI("DialogueUI")
        end
    else
        -- 如果UI对象不存在，使用ShowLuaUI作为后备方案
        UIHelper.ShowLuaUI("DialogueUI")
    end
    isDialogueActive = true
end

-- 关闭对话
function DialogueManager.CloseDialogue()
    if currentDialogueUI and isDialogueActive then
        local dialogueUIModule = require("ui.DialogueUI")
        if dialogueUIModule then
            dialogueUIModule.CloseDialogue()
        else
            UIHelper.HideLuaUI("DialogueUI")
        end
        isDialogueActive = false
    end
    
    -- 清除对话状态
    currentDialogueState.npcID = nil
    currentDialogueState.currentNodeId = nil
    currentDialogueState.tree = nil
    currentDialogueState.onClosed = nil
end

-- 显示多段对话（对话树）
-- @param npcID NPC的ID
-- @param npcName NPC名称
-- @param avatarPath NPC头像路径（可选）
-- @param onClosed 对话关闭回调（可选）
function DialogueManager.ShowDialogueTree(npcID, npcName, avatarPath, onClosed)
    -- 加载对话配置
    local DialogueTreeConfig = require("rpg.table.dialogue_tree_config")
    if not DialogueTreeConfig then
        print("[DialogueManager] 错误: 无法加载对话配置模块")
        return
    end
    
    -- 获取对话树
    local tree = DialogueTreeConfig.GetTree(npcID)
    if not tree then
        print("[DialogueManager] 警告: NPC ID=" .. npcID .. " 没有对话树配置")
        return
    end
    
    -- 获取起始节点
    local startNode = DialogueTreeConfig.GetStartNode(npcID)
    if not startNode then
        print("[DialogueManager] 错误: NPC ID=" .. npcID .. " 的起始对话节点不存在")
        return
    end
    
    -- 保存对话状态
    currentDialogueState.npcID = npcID
    currentDialogueState.currentNodeId = startNode.id
    currentDialogueState.tree = tree
    currentDialogueState.onClosed = onClosed
    
    -- 显示第一个对话节点
    DialogueManager.ShowDialogueNode(npcID, startNode.id, npcName, avatarPath)
end

-- 显示单段对话（简化配置）
-- @param npcID NPC的ID
-- @param npcName NPC名称
-- @param avatarPath NPC头像路径（可选）
-- @param onOptionSelected 选项选择回调（可选）
-- @param onClosed 对话关闭回调（可选）
function DialogueManager.ShowSimpleDialogue(npcID, npcName, avatarPath, onOptionSelected, onClosed)
    -- 加载对话配置
    local DialogueTreeConfig = require("rpg.table.dialogue_tree_config")
    if not DialogueTreeConfig then
        print("[DialogueManager] 错误: 无法加载对话配置模块")
        return
    end
    
    -- 获取单段对话配置
    local dialogue = DialogueTreeConfig.GetSimpleDialogue(npcID)
    if not dialogue then
        print("[DialogueManager] 警告: NPC ID=" .. npcID .. " 没有单段对话配置")
        return
    end
    
    -- 创建选项选择回调
    local optionCallback = function(option, index)
        if onOptionSelected then
            onOptionSelected(option, index)
        end
        
        -- 处理关闭动作
        if option.action == "close" then
            DialogueManager.CloseDialogue()
        end
    end
    
    -- 显示对话
    DialogueManager.ShowDialogue(
        npcName,
        dialogue.npcText,
        avatarPath,
        dialogue.options or {},
        optionCallback,
        onClosed
    )
end

-- 显示对话节点（内部函数）
-- @param npcID NPC的ID
-- @param nodeId 对话节点ID
-- @param npcName NPC名称
-- @param avatarPath NPC头像路径（可选）
function DialogueManager.ShowDialogueNode(npcID, nodeId, npcName, avatarPath)
    local DialogueTreeConfig = require("rpg.table.dialogue_tree_config")
    local node = DialogueTreeConfig.GetNode(npcID, nodeId)
    
    if not node then
        print("[DialogueManager] 错误: 对话节点不存在 - NPC ID=" .. npcID .. ", Node ID=" .. nodeId)
        DialogueManager.CloseDialogue()
        return
    end
    
    -- 更新当前节点ID
    currentDialogueState.currentNodeId = nodeId
    
    -- 创建选项选择回调
    local optionCallback = function(option, index)
        print("[DialogueManager] 玩家选择了选项: " .. tostring(option.text))
        
        -- 检查是否有下一个节点
        if option.nextNodeId and option.nextNodeId > 0 then
            -- 跳转到下一个对话节点
            DialogueManager.ShowDialogueNode(npcID, option.nextNodeId, npcName, avatarPath)
        else
            -- 结束对话
            DialogueManager.CloseDialogue()
        end
        
        -- 执行自定义动作（如果有）
        if option.action then
            -- 可以在这里处理自定义动作
            print("[DialogueManager] 执行动作: " .. tostring(option.action))
        end
    end
    
    -- 显示对话
    DialogueManager.ShowDialogue(
        npcName,
        node.npcText,
        avatarPath,
        node.options or {},  -- 选项列表
        optionCallback,      -- 选项选择回调
        currentDialogueState.onClosed  -- 对话关闭回调
    )
end

-- 检查是否有对话正在显示
function DialogueManager.IsDialogueActive()
    return isDialogueActive
end

-- 设置对话UI路径（运行时修改）
function DialogueManager.SetDialogueUIPath(path)
    dialogueUIPath = path or "UI/DialogueUI"
end

-- 初始化（可选，如果需要的话）
function DialogueManager.Initialize()
    print("[DialogueManager] 对话管理器已初始化")
end

return DialogueManager

