---@diagnostic disable: undefined-global
---@diagnostic disable: unused-local
---@diagnostic disable: unused-function
-- 游戏开始事件处理
-- 当C#触发GAME_START事件时，此脚本中的回调函数会被调用

local EventHelper = require("event_helper")

local function LoadPlayer()
    local playerPrefab = ResHelper.LoadGameObject("Prefabs/Player/Player")
    local parentObj = UnityEngine.GameObject.Find("Player")
    local player = ResHelper.Instantiate(playerPrefab, parentObj.transform)
    player.transform.localPosition = UnityEngine.Vector3(0, 0, 0)
    local cinemachineCameraObj = UnityEngine.GameObject.Find("CinemachineCamera")
    local virtualCamera = cinemachineCameraObj:GetComponent(typeof(CS.Unity.Cinemachine.CinemachineCamera))
    virtualCamera.Follow = player.transform
    virtualCamera.LookAt = player.transform
end 

local function LoadNPC()
    -- C#+Lua混合架构：核心逻辑在C#，业务逻辑在Lua
    -- C#负责：距离检测、输入检测、UI创建（性能敏感）
    -- Lua负责：数据传递、对话内容、交互流程（需要热更新）
    local npcConfig = Table.NPCConfig.datas;
    local parentObj = UnityEngine.GameObject.Find("NPC_Test")
    local npcPrefab = ResHelper.LoadGameObject("Prefabs/NPC_Model")
    
    for k, v in pairs(npcConfig) do
        local npc = ResHelper.Instantiate(npcPrefab, parentObj.transform)
        npc.name = v.Name
        
        -- 获取或添加NPCController组件（C#核心逻辑）
        local npcController = npc:GetComponent(typeof(CS.NPCController))
        if npcController == nil then
            npcController = npc:AddComponent(typeof(CS.NPCController))
        end
        
        -- 从Lua传递配置数据给C#，由C#负责所有核心逻辑
        npcController:InitializeFromLua(
            v.ID,
            v.Name,
            v.DialogueText,
            tonumber(v.InteractionDistance),
            v.InteractionKey,
            tonumber(v.PositionX),
            tonumber(v.PositionY),
            tonumber(v.PositionZ),
            tonumber(v.RotationY)
        )
    end
end
local function LoadPortal()
    local PortalTable = Table.PortalConfig.datas
    local parentObj = UnityEngine.GameObject.Find("Portal_Test")
    local PortalPrefab = ResHelper.LoadGameObject("Prefabs/Portal_Model");
    for k, v in pairs(PortalTable) do
        local Portal = ResHelper.Instantiate(PortalPrefab, parentObj)
        Portal.name = v.Name
    end
end

-- 游戏开始事件回调函数
-- 此函数会被事件系统动态调用，不会被标记为未使用
local function OnGameStart()
    print("[Lua] ========== 游戏开始！ ==========")
    print("[Lua] 当前时间: " .. os.date("%Y-%m-%d %H:%M:%S"))
    LoadPlayer()
    LoadNPC()
    -- LoadPortal()
end
-- LoadNPC函数会被OnGameStart调用


EventHelper.Register(EventHelper.Events.GAME_START, OnGameStart)

print("[Lua] gamestart.lua 已加载，游戏开始事件监听器已注册")

