---@diagnostic disable: undefined-global
---@diagnostic disable: unused-local
---@diagnostic disable: unused-function
-- 游戏开始事件处理
-- 当C#触发GAME_START事件时，此脚本中的回调函数会被调用

local EventHelper = require("event_helper")

local function LoadPlayer()
    local playerPrefab = ResHelper.LoadGameObject("Prefabs/Player/Player")
    local parentObj = UnityEngine.GameObject.Find("Player")
    local player = ResHelper.Instantiate(playerPrefab, parentObj.transform)
    player.transform.localPosition = UnityEngine.Vector3(0, 0, 0)
    local cinemachineCameraObj = UnityEngine.GameObject.Find("CinemachineCamera")
    local virtualCamera = cinemachineCameraObj:GetComponent(typeof(CS.Unity.Cinemachine.CinemachineCamera))
    virtualCamera.Follow = player.transform
    virtualCamera.LookAt = player.transform
end 

local function LoadNPC()
    local npcConfig = Table.NPCConfig.datas;
    local parentObj = UnityEngine.GameObject.Find("NPC_Test")
    local npcPrefab = ResHelper.LoadGameObject("Prefabs/NPC_Model")  
    for k, v in pairs(npcConfig) do
        local npc = ResHelper.Instantiate(npcPrefab, parentObj.transform)
        npc.name = v.Name
        local npcController = npc:GetComponent(typeof(CS.NPCController))
        if npcController == nil then
            npcController = npc:AddComponent(typeof(CS.NPCController))
        end
        npcController:InitializeFromLua(
            v.ID,
            v.Name,
            v.DialogueText,
            tonumber(v.InteractionDistance),
            v.InteractionKey,
            tonumber(v.PositionX),
            tonumber(v.PositionY),
            tonumber(v.PositionZ),
            tonumber(v.RotationY)
        )
    end
end
local function LoadPortal()
    local PortalTable = Table.PortalConfig.datas
    local parentObj = UnityEngine.GameObject.Find("Portal_Test")
    local PortalPrefab = ResHelper.LoadGameObject("Prefabs/Portal_Model");
    for k, v in pairs(PortalTable) do
        local Portal = ResHelper.Instantiate(PortalPrefab, parentObj.transform)
        Portal.name = v.Name
        local portalController = Portal:GetComponent(typeof(CS.PortalController))
        if portalController == nil then
            portalController = Portal:AddComponent(typeof(CS.PortalController))
        end
        portalController:InitializeFromLua(
            v.ID,
            v.Name,
            v.TargetSceneName,
            v.Description,
            tonumber(v.InteractionDistance),
            tonumber(v.TeleportDelay),
            v.InteractionKey,
            tonumber(v.PositionX),
            tonumber(v.PositionY),
            tonumber(v.PositionZ),
            tonumber(v.RotationY)
        )
    end
end

-- 游戏开始事件回调函数
-- 此函数会被事件系统动态调用，不会被标记为未使用
local function OnGameStart()
    print("[Lua] ========== 游戏开始！ ==========")
    print("[Lua] 当前时间: " .. os.date("%Y-%m-%d %H:%M:%S"))
    LoadPlayer()
    LoadNPC()
    LoadPortal()
end
-- LoadNPC函数会被OnGameStart调用


EventHelper.Register(EventHelper.Events.GAME_START, OnGameStart)

print("[Lua] gamestart.lua 已加载，游戏开始事件监听器已注册")

