---@diagnostic disable: undefined-global
---@diagnostic disable: unused-local
-- 对话UI - Lua实现
-- 支持热更新，所有UI逻辑都在Lua中

local DialogueUI = {}

-- UI组件引用
local currentUI = nil
local npcNameText = nil
local dialogueText = nil
local npcAvatarImage = nil
local closeButton = nil
local dialoguePanel = nil

-- 设置
local typingSpeed = 0.05  -- 打字机效果速度
local useTypingEffect = true  -- 是否使用打字机效果

-- 状态
local currentDialogue = ""
local typingCoroutine = nil
local onDialogueClosed = nil
local isTyping = false

-- 初始化UI组件引用
local function InitializeComponents(ui)
    -- 查找NPC名称文本（支持TextMeshPro和普通Text）
    local npcNameObj = ui.transform:Find("DialoguePanel/NPCNameText")
    if not npcNameObj then
        npcNameObj = ui.transform:Find("DialoguePanel/NPCName")
    end
    if npcNameObj then
        npcNameText = npcNameObj:GetComponent("TextMeshProUGUI")
        if not npcNameText then
            npcNameText = npcNameObj:GetComponent("Text")
        end
    end
    
    -- 查找对话文本
    local dialogueObj = ui.transform:Find("DialoguePanel/DialogueText")
    if not dialogueObj then
        dialogueObj = ui.transform:Find("DialoguePanel/Content")
    end
    if dialogueObj then
        dialogueText = dialogueObj:GetComponent("TextMeshProUGUI")
        if not dialogueText then
            dialogueText = dialogueObj:GetComponent("Text")
        end
    end
    
    -- 查找NPC头像
    local avatarObj = ui.transform:Find("DialoguePanel/NPCAvatar")
    if not avatarObj then
        avatarObj = ui.transform:Find("DialoguePanel/Avatar")
    end
    if avatarObj then
        npcAvatarImage = avatarObj:GetComponent("Image")
    end
    
    -- 查找关闭按钮
    local closeBtnObj = ui.transform:Find("DialoguePanel/CloseButton")
    if not closeBtnObj then
        closeBtnObj = ui.transform:Find("DialoguePanel/CloseBtn")
    end
    if closeBtnObj then
        closeButton = closeBtnObj:GetComponent("Button")
    end
    
    -- 查找对话面板
    dialoguePanel = ui.transform:Find("DialoguePanel")
    if not dialoguePanel then
        dialoguePanel = ui.transform
    end
end

-- 打字机效果协程
local function TypeText(text)
    if not dialogueText then
        return
    end
    
    isTyping = true
    dialogueText.text = ""
    
    local index = 1
    local function NextChar()
        if index > #text then
            -- 打字完成
            isTyping = false
            typingCoroutine = nil
            return
        end
        
        -- 显示当前字符
        dialogueText.text = string.sub(text, 1, index)
        index = index + 1
        
        -- 延迟显示下一个字符
        typingCoroutine = CoroutineHelper.DelayCall(NextChar, typingSpeed)
    end
    
    -- 开始打字
    NextChar()
end

-- 跳过打字机效果
function DialogueUI.SkipTyping()
    if isTyping and dialogueText then
        -- 直接显示全部文本，DelayCall会自动完成（不需要手动停止）
        typingCoroutine = nil
        dialogueText.text = currentDialogue
        isTyping = false
    end
end

-- 显示对话
function DialogueUI.ShowDialogue(npcName, dialogue, avatarPath, onClosed)
    if not currentUI then
        print("[DialogueUI] 错误: UI未初始化")
        return
    end
    
    -- 设置NPC名称
    if npcNameText then
        npcNameText.text = npcName or ""
    end
    
    -- 保存对话内容和回调
    currentDialogue = dialogue or ""
    onDialogueClosed = onClosed
    
    -- 设置头像
    if npcAvatarImage then
        if avatarPath and avatarPath ~= "" then
            local sprite = ResHelper.Load(avatarPath, "Sprite")
            if sprite then
                npcAvatarImage.sprite = sprite
                npcAvatarImage.gameObject:SetActive(true)
            else
                npcAvatarImage.gameObject:SetActive(false)
            end
        else
            npcAvatarImage.gameObject:SetActive(false)
        end
    end
    
    -- 显示对话文本
    if useTypingEffect and currentDialogue ~= "" then
        -- 使用打字机效果
        if typingCoroutine then
            CoroutineHelper.Stop(typingCoroutine)
        end
        TypeText(currentDialogue)
    else
        -- 直接显示全部文本
        if dialogueText then
            dialogueText.text = currentDialogue
        end
        isTyping = false
    end
    
    -- 显示面板
    if dialoguePanel then
        dialoguePanel.gameObject:SetActive(true)
    end
end

-- 关闭对话
function DialogueUI.CloseDialogue()
    -- 如果正在打字，直接显示全部文本
    if isTyping then
        DialogueUI.SkipTyping()
        return
    end
    
    -- 调用回调
    if onDialogueClosed then
        onDialogueClosed()
        onDialogueClosed = nil
    end
    
    -- 隐藏UI
    if currentUI then
        UIHelper.HideLuaUI("DialogueUI")
    end
end

-- 检查是否可以关闭
function DialogueUI.CanClose()
    return not isTyping
end

-- Unity生命周期：初始化
function DialogueUI.OnInitialize(ui)
    print("[DialogueUI.lua] OnInitialize被调用")
    currentUI = ui
    
    -- 初始化组件引用
    InitializeComponents(ui)
    
    -- 绑定关闭按钮
    if closeButton then
        UIHelper.BindButtonWithSound(closeButton, DialogueUI.CloseDialogue)
    end
    
    -- 默认隐藏面板
    if dialoguePanel then
        dialoguePanel.gameObject:SetActive(false)
    end
end

-- Unity生命周期：显示
function DialogueUI.OnShow(ui)
    print("[DialogueUI.lua] OnShow被调用")
    if dialoguePanel then
        dialoguePanel.gameObject:SetActive(true)
    end
end

-- Unity生命周期：隐藏
function DialogueUI.OnHide(ui)
    print("[DialogueUI.lua] OnHide被调用")
    
    -- 停止打字机效果
    if typingCoroutine then
        CoroutineHelper.Stop(typingCoroutine)
        typingCoroutine = nil
    end
    isTyping = false
    
    if dialoguePanel then
        dialoguePanel.gameObject:SetActive(false)
    end
end

-- Unity生命周期：销毁
function DialogueUI.OnDestroy(ui)
    print("[DialogueUI.lua] OnDestroy被调用")
    
    -- 清理
    if typingCoroutine then
        CoroutineHelper.Stop(typingCoroutine)
        typingCoroutine = nil
    end
    
    currentUI = nil
    npcNameText = nil
    dialogueText = nil
    npcAvatarImage = nil
    closeButton = nil
    dialoguePanel = nil
    onDialogueClosed = nil
end

-- Unity生命周期：Update（检测输入）
function DialogueUI.Update(ui)
    if not currentUI or not currentUI.gameObject.activeSelf then
        return
    end
    
    -- 检测ESC键关闭对话
    if CS.UnityEngine.Input.GetKeyDown(CS.UnityEngine.KeyCode.Escape) then
        DialogueUI.CloseDialogue()
        return
    end
    
    -- 检测鼠标左键或空格键
    if CS.UnityEngine.Input.GetMouseButtonDown(0) or CS.UnityEngine.Input.GetKeyDown(CS.UnityEngine.KeyCode.Space) then
        if DialogueUI.CanClose() then
            DialogueUI.CloseDialogue()
        else
            DialogueUI.SkipTyping()
        end
    end
end

return DialogueUI

